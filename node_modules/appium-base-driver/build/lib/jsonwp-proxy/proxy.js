'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _jsonwpStatusStatus = require('../jsonwp-status/status');

var _protocolErrors = require('../protocol/errors');

var _basedriverDriver = require('../basedriver/driver');

var _basedriverDriver2 = _interopRequireDefault(_basedriverDriver);

var _protocolRoutes = require('../protocol/routes');

var log = _appiumSupport.logger.getLogger('JSONWP Proxy');
// TODO: Make this value configurable as a server side capability
var LOG_OBJ_LENGTH = 1024; // MAX LENGTH Logged to file / console
var DEFAULT_REQUEST_TIMEOUT = 240000;

var COMMAND_URLS_CONFLICTS = [{
  commandNames: ['execute', 'executeAsync'],
  jsonwpConverter: function jsonwpConverter(url) {
    return url.replace(/\/execute.*/, url.includes('async') ? '/execute_async' : '/execute');
  },
  w3cConverter: function w3cConverter(url) {
    return url.replace(/\/execute.*/, url.includes('async') ? '/execute/async' : '/execute/sync');
  }
}, {
  commandNames: ['getElementScreenshot'],
  jsonwpConverter: function jsonwpConverter(url) {
    return url.replace(/\/element\/([^\/]+)\/screenshot$/, '/screenshot/$1');
  },
  w3cConverter: function w3cConverter(url) {
    return url.replace(/\/screenshot\/([^\/]+)/, '/element/$1/screenshot');
  }
}];

var _BaseDriver$DRIVER_PROTOCOL = _basedriverDriver2['default'].DRIVER_PROTOCOL;
var MJSONWP = _BaseDriver$DRIVER_PROTOCOL.MJSONWP;
var W3C = _BaseDriver$DRIVER_PROTOCOL.W3C;

var JWProxy = (function () {
  function JWProxy() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, JWProxy);

    _Object$assign(this, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: '/wd/hub',
      sessionId: null,
      timeout: DEFAULT_REQUEST_TIMEOUT
    }, opts);
    this.scheme = this.scheme.toLowerCase();
    this._activeRequests = [];
  }

  // abstract the call behind a member function
  // so that we can mock it in tests

  _createClass(JWProxy, [{
    key: 'request',
    value: function request() {
      var currentRequest,
          args$2$0 = arguments;
      return _regeneratorRuntime.async(function request$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            currentRequest = _requestPromise2['default'].apply(undefined, args$2$0);

            this._activeRequests.push(currentRequest);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(currentRequest['finally'](function () {
              return _lodash2['default'].pull(_this._activeRequests, currentRequest);
            }));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getActiveRequestsCount',
    value: function getActiveRequestsCount() {
      return this._activeRequests.length;
    }
  }, {
    key: 'cancelActiveRequests',
    value: function cancelActiveRequests() {
      try {
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
          for (var _iterator = _getIterator(this._activeRequests), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
            var r = _step.value;

            r.cancel();
          }
        } catch (err) {
          _didIteratorError = true;
          _iteratorError = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }
          } finally {
            if (_didIteratorError) {
              throw _iteratorError;
            }
          }
        }
      } finally {
        this._activeRequests = [];
      }
    }
  }, {
    key: 'endpointRequiresSessionId',
    value: function endpointRequiresSessionId(endpoint) {
      return !_lodash2['default'].includes(['/session', '/sessions', '/status'], endpoint);
    }
  }, {
    key: 'getUrlForProxy',
    value: function getUrlForProxy(url) {
      if (url === '') {
        url = '/';
      }
      var proxyBase = this.scheme + '://' + this.server + ':' + this.port + this.base;
      var endpointRe = '(/(session|status))';
      var remainingUrl = '';
      if (/^http/.test(url)) {
        var first = new RegExp('(https?://.+)' + endpointRe).exec(url);
        if (!first) {
          throw new Error('Got a complete url but could not extract JWP endpoint');
        }
        remainingUrl = url.replace(first[1], '');
      } else if (new RegExp('^/').test(url)) {
        remainingUrl = url;
      } else {
        throw new Error('Did not know what to do with url \'' + url + '\'');
      }

      var stripPrefixRe = new RegExp('^.*?(/(session|status).*)$');
      if (stripPrefixRe.test(remainingUrl)) {
        remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
      }

      if (!new RegExp(endpointRe).test(remainingUrl)) {
        remainingUrl = '/session/' + this.sessionId + remainingUrl;
      }

      var requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

      if (requiresSessionId && this.sessionId === null) {
        throw new Error('Trying to proxy a session command without session id');
      }

      var sessionBaseRe = new RegExp('^/session/([^/]+)');
      if (sessionBaseRe.test(remainingUrl)) {
        // we have something like /session/:id/foobar, so we need to replace
        // the session id
        var match = sessionBaseRe.exec(remainingUrl);
        remainingUrl = remainingUrl.replace(match[1], this.sessionId);
      } else if (requiresSessionId) {
        throw new Error('Could not find :session section for url: ' + remainingUrl);
      }
      remainingUrl = remainingUrl.replace(/\/$/, ''); // can't have trailing slashes

      return proxyBase + remainingUrl;
    }
  }, {
    key: 'proxy',
    value: function proxy(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];
      var newUrl, reqOpts, res, resBody, resBodyObj, message, err, responseError;
      return _regeneratorRuntime.async(function proxy$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            method = method.toUpperCase();
            newUrl = this.getUrlForProxy(url);
            reqOpts = {
              url: newUrl,
              method: method,
              headers: {
                'content-type': 'application/json; charset=utf-8',
                'user-agent': 'appium',
                accept: '*/*'
              },
              resolveWithFullResponse: true,
              timeout: this.timeout,
              forever: true
            };

            if (body !== null) {
              if (typeof body !== 'object') {
                body = JSON.parse(body);
              }
              reqOpts.json = body;
            }

            // GET methods shouldn't have any body. Most servers are OK with this, but WebDriverAgent throws 400 errors
            if (method === 'GET') {
              reqOpts.json = null;
            }

            log.debug('Proxying [' + method + ' ' + (url || "/") + '] to [' + method + ' ' + newUrl + '] ' + (body ? 'with body: ' + _lodash2['default'].truncate(JSON.stringify(body), { length: LOG_OBJ_LENGTH }) : 'with no body'));

            res = undefined, resBody = undefined;
            context$2$0.prev = 7;
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.request(reqOpts));

          case 10:
            res = context$2$0.sent;

            resBody = res.body;
            log.debug('Got response with status ' + res.statusCode + ': ' + _lodash2['default'].truncate(JSON.stringify(resBody), { length: LOG_OBJ_LENGTH }));
            if (/\/session$/.test(url) && method === 'POST') {
              if (res.statusCode === 200) {
                this.sessionId = resBody.sessionId;
              } else if (res.statusCode === 303) {
                this.sessionId = /\/session\/([^\/]+)/.exec(resBody)[1];
              }
            }
            resBodyObj = _appiumSupport.util.safeJsonParse(resBody);

            if (!this._downstreamProtocol) {
              this._downstreamProtocol = this.getProtocolFromResBody(resBodyObj);
            }

            if (!(res.statusCode < 400 && this._downstreamProtocol === MJSONWP && parseInt(resBodyObj.status, 10) !== 0)) {
              context$2$0.next = 23;
              break;
            }

            message = 'The request to ' + url + ' has failed';
            err = new Error(message);

            err.message = message;
            err.error = resBody;
            err.statusCode = 500;
            throw err;

          case 23:
            context$2$0.next = 30;
            break;

          case 25:
            context$2$0.prev = 25;
            context$2$0.t0 = context$2$0['catch'](7);
            responseError = undefined;

            try {
              responseError = JSON.parse(context$2$0.t0.error);
            } catch (e1) {
              if (!_lodash2['default'].isEmpty(context$2$0.t0.error) && _lodash2['default'].isString(context$2$0.t0.error)) {
                log.warn('Got an unexpected response: ' + _lodash2['default'].truncate(context$2$0.t0.error, { length: 300 }));
              }
              responseError = _lodash2['default'].isPlainObject(context$2$0.t0.error) ? context$2$0.t0.error : null;
            }
            throw new _protocolErrors.errors.ProxyRequestError('Could not proxy command to remote server. ' + ('Original error: ' + context$2$0.t0.message), responseError, context$2$0.t0.statusCode);

          case 30:
            return context$2$0.abrupt('return', [res, resBody]);

          case 31:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[7, 25]]);
    }

    /**
     * W3C /timeouts can take as many as 3 timeout types at once, MJSONWP /timeouts only takes one
     * at a time. So if we're using W3C and proxying to MJSONWP and there's more than one timeout type
     * provided in the request, we need to do 3 proxies and combine the result
     *
     * @param {Object} body Request body
     * @return {Array} Array of W3C + MJSONWP compatible timeout objects
     */
  }, {
    key: 'getTimeoutRequestObjects',
    value: function getTimeoutRequestObjects(body) {
      var downstreamProtocol, typeToW3C, _ret;

      return _regeneratorRuntime.async(function getTimeoutRequestObjects$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            downstreamProtocol = undefined;
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.getDownstreamProtocol());

          case 4:
            downstreamProtocol = context$2$0.sent;
            context$2$0.next = 10;
            break;

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](1);

            log.warn(context$2$0.t0);

          case 10:
            if (downstreamProtocol) {
              context$2$0.next = 13;
              break;
            }

            log.warn('The downstream protocol cannot be detected. Proxying the request body to /timeouts as is');
            return context$2$0.abrupt('return', [body]);

          case 13:
            if (!(downstreamProtocol === W3C && _lodash2['default'].has(body, 'ms') && _lodash2['default'].has(body, 'type'))) {
              context$2$0.next = 16;
              break;
            }

            typeToW3C = function typeToW3C(x) {
              return x === 'page load' ? 'pageLoad' : x;
            };

            return context$2$0.abrupt('return', [_defineProperty({}, typeToW3C(body.type), body.ms)]);

          case 16:
            if (!(downstreamProtocol === MJSONWP && (!_lodash2['default'].has(body, 'ms') || !_lodash2['default'].has(body, 'type')))) {
              context$2$0.next = 20;
              break;
            }

            _ret = (function () {
              var typeToJSONWP = function typeToJSONWP(x) {
                return x === 'pageLoad' ? 'page load' : x;
              };
              return {
                v: _lodash2['default'].toPairs(body).filter(function (pair) {
                  return !isNaN(parseFloat(pair[1]));
                }).map(function (pair) {
                  return {
                    type: typeToJSONWP(pair[0]),
                    ms: pair[1]
                  };
                })
              };
            })();

            if (!(typeof _ret === 'object')) {
              context$2$0.next = 20;
              break;
            }

            return context$2$0.abrupt('return', _ret.v);

          case 20:
            return context$2$0.abrupt('return', [body]);

          case 21:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 7]]);
    }

    /**
     * Proxy an array of timeout objects and merge the result
     * @param {String} url Endpoint url
     * @param {String} method Endpoint method
     * @param {Object} body Request body
     */
  }, {
    key: 'proxySetTimeouts',
    value: function proxySetTimeouts(url, method, body) {
      var response, resBody, timeoutRequestObjects, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, timeoutObj, _ref2, _ref22, protocol;

      return _regeneratorRuntime.async(function proxySetTimeouts$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            response = undefined, resBody = undefined;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getTimeoutRequestObjects(body));

          case 3:
            timeoutRequestObjects = context$2$0.sent;

            log.debug('Will send the following request bodies to /timeouts: ' + JSON.stringify(timeoutRequestObjects));
            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            context$2$0.prev = 8;
            _iterator2 = _getIterator(timeoutRequestObjects);

          case 10:
            if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
              context$2$0.next = 26;
              break;
            }

            timeoutObj = _step2.value;
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.proxy(url, method, timeoutObj));

          case 14:
            _ref2 = context$2$0.sent;
            _ref22 = _slicedToArray(_ref2, 2);
            response = _ref22[0];
            resBody = _ref22[1];
            protocol = this.getProtocolFromResBody(resBody);

            if (!(protocol !== MJSONWP)) {
              context$2$0.next = 21;
              break;
            }

            return context$2$0.abrupt('return', [response, resBody]);

          case 21:
            if (!(response.statusCode >= 400)) {
              context$2$0.next = 23;
              break;
            }

            return context$2$0.abrupt('return', [response, resBody]);

          case 23:
            _iteratorNormalCompletion2 = true;
            context$2$0.next = 10;
            break;

          case 26:
            context$2$0.next = 32;
            break;

          case 28:
            context$2$0.prev = 28;
            context$2$0.t0 = context$2$0['catch'](8);
            _didIteratorError2 = true;
            _iteratorError2 = context$2$0.t0;

          case 32:
            context$2$0.prev = 32;
            context$2$0.prev = 33;

            if (!_iteratorNormalCompletion2 && _iterator2['return']) {
              _iterator2['return']();
            }

          case 35:
            context$2$0.prev = 35;

            if (!_didIteratorError2) {
              context$2$0.next = 38;
              break;
            }

            throw _iteratorError2;

          case 38:
            return context$2$0.finish(35);

          case 39:
            return context$2$0.finish(32);

          case 40:
            return context$2$0.abrupt('return', [response, resBody]);

          case 41:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[8, 28, 32, 40], [33,, 35, 39]]);
    }
  }, {
    key: 'getProtocolFromResBody',
    value: function getProtocolFromResBody(resBody) {
      if (!_lodash2['default'].isPlainObject(resBody)) {
        try {
          resBody = JSON.parse(resBody);
        } catch (err) {
          return;
        }
      }
      if (_appiumSupport.util.hasValue(resBody.status)) {
        return MJSONWP;
      }
      if (_appiumSupport.util.hasValue(resBody.value)) {
        return W3C;
      }
    }
  }, {
    key: 'getDownstreamProtocol',
    value: function getDownstreamProtocol() {
      var _ref3, _ref32, resBody;

      return _regeneratorRuntime.async(function getDownstreamProtocol$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this._downstreamProtocol) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.proxy('/status', 'GET'));

          case 3:
            _ref3 = context$2$0.sent;
            _ref32 = _slicedToArray(_ref3, 2);
            resBody = _ref32[1];

            this._downstreamProtocol = this.getProtocolFromResBody(resBody);

          case 7:
            return context$2$0.abrupt('return', this._downstreamProtocol);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'requestToCommandName',
    value: function requestToCommandName(url, method) {
      var extractCommandName = function extractCommandName(pattern) {
        var pathMatch = pattern.exec(url);
        return pathMatch ? (0, _protocolRoutes.routeToCommandName)(pathMatch[1], method) : null;
      };
      var commandName = (0, _protocolRoutes.routeToCommandName)(url, method);
      if (!commandName && _lodash2['default'].includes(url, '/wd/hub/session/')) {
        commandName = extractCommandName(/\/wd\/hub\/session\/[^\/]+(.+)/);
      }
      if (!commandName && _lodash2['default'].includes(url, '/wd/hub/')) {
        commandName = extractCommandName(/\/wd\/hub(\/.+)/);
      }
      return commandName;
    }
  }, {
    key: 'proxyCommand',
    value: function proxyCommand(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];

      var commandName, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, _step3$value,

      // Same arguments, but different URLs

      commandNames, jsonwpConverter, w3cConverter, downstreamProtocol, rewrittenUrl;

      return _regeneratorRuntime.async(function proxyCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            commandName = this.requestToCommandName(url, method);

            if (commandName) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.proxy(url, method, body));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
            log.debug('Matched \'' + url + '\' to command name \'' + commandName + '\'');

            // Handle "crossing" endpoints for the case
            // when upstream and downstream drivers operate different protocols

            // Same url, but different arguments

            if (!(commandName === 'timeouts')) {
              context$2$0.next = 10;
              break;
            }

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.proxySetTimeouts(url, method, body));

          case 9:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 10:
            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            context$2$0.prev = 13;
            _iterator3 = _getIterator(COMMAND_URLS_CONFLICTS);

          case 15:
            if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
              context$2$0.next = 46;
              break;
            }

            _step3$value = _step3.value;
            commandNames = _step3$value.commandNames;
            jsonwpConverter = _step3$value.jsonwpConverter;
            w3cConverter = _step3$value.w3cConverter;

            if (commandNames.includes(commandName)) {
              context$2$0.next = 22;
              break;
            }

            return context$2$0.abrupt('continue', 43);

          case 22:
            downstreamProtocol = undefined;
            context$2$0.prev = 23;
            context$2$0.next = 26;
            return _regeneratorRuntime.awrap(this.getDownstreamProtocol());

          case 26:
            downstreamProtocol = context$2$0.sent;
            context$2$0.next = 32;
            break;

          case 29:
            context$2$0.prev = 29;
            context$2$0.t0 = context$2$0['catch'](23);

            log.warn(context$2$0.t0);

          case 32:
            if (downstreamProtocol) {
              context$2$0.next = 35;
              break;
            }

            log.warn('The downstream protocol cannot be detected. Proxying as is');
            return context$2$0.abrupt('break', 46);

          case 35:
            rewrittenUrl = downstreamProtocol === MJSONWP ? jsonwpConverter(url) : w3cConverter(url);

            if (!(rewrittenUrl === url)) {
              context$2$0.next = 39;
              break;
            }

            log.debug('Did not know how to rewrite the original URL \'' + url + '\' ' + ('for ' + downstreamProtocol + ' protocol'));
            return context$2$0.abrupt('break', 46);

          case 39:
            log.info('Rewrote the original URL \'' + url + '\' to \'' + rewrittenUrl + '\' ' + ('for ' + downstreamProtocol + ' protocol'));
            context$2$0.next = 42;
            return _regeneratorRuntime.awrap(this.proxy(rewrittenUrl, method, body));

          case 42:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 43:
            _iteratorNormalCompletion3 = true;
            context$2$0.next = 15;
            break;

          case 46:
            context$2$0.next = 52;
            break;

          case 48:
            context$2$0.prev = 48;
            context$2$0.t1 = context$2$0['catch'](13);
            _didIteratorError3 = true;
            _iteratorError3 = context$2$0.t1;

          case 52:
            context$2$0.prev = 52;
            context$2$0.prev = 53;

            if (!_iteratorNormalCompletion3 && _iterator3['return']) {
              _iterator3['return']();
            }

          case 55:
            context$2$0.prev = 55;

            if (!_didIteratorError3) {
              context$2$0.next = 58;
              break;
            }

            throw _iteratorError3;

          case 58:
            return context$2$0.finish(55);

          case 59:
            return context$2$0.finish(52);

          case 60:
            context$2$0.next = 62;
            return _regeneratorRuntime.awrap(this.proxy(url, method, body));

          case 62:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 63:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[13, 48, 52, 60], [23, 29], [53,, 55, 59]]);
    }
  }, {
    key: 'command',
    value: function command(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];

      var response, resBody, _ref4, _ref42, protocol, _status, message;

      return _regeneratorRuntime.async(function command$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            response = undefined;
            resBody = undefined;
            context$2$0.prev = 2;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.proxyCommand(url, method, body));

          case 5:
            _ref4 = context$2$0.sent;
            _ref42 = _slicedToArray(_ref4, 2);
            response = _ref42[0];
            resBody = _ref42[1];
            context$2$0.next = 16;
            break;

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](2);

            if (!(0, _protocolErrors.isErrorType)(context$2$0.t0, _protocolErrors.errors.ProxyRequestError)) {
              context$2$0.next = 15;
              break;
            }

            throw context$2$0.t0.getActualError();

          case 15:
            throw new _protocolErrors.errors.UnknownError(context$2$0.t0.message);

          case 16:
            resBody = _appiumSupport.util.safeJsonParse(resBody);
            protocol = this.getProtocolFromResBody(resBody);

            if (!(protocol === MJSONWP)) {
              context$2$0.next = 28;
              break;
            }

            if (!(response.statusCode === 200 && resBody.status === 0)) {
              context$2$0.next = 21;
              break;
            }

            return context$2$0.abrupt('return', resBody.value);

          case 21:
            _status = parseInt(resBody.status, 10);

            if (!(!isNaN(_status) && _status !== 0)) {
              context$2$0.next = 26;
              break;
            }

            message = resBody.value;

            if (_lodash2['default'].has(resBody.value, 'message')) {
              message = _lodash2['default'].isEmpty(message) ? resBody.value.message : message + ' ' + resBody.value.message;
            }
            throw (0, _protocolErrors.errorFromMJSONWPStatusCode)(_status, _lodash2['default'].isEmpty(message) ? (0, _jsonwpStatusStatus.getSummaryByCode)(_status) : message);

          case 26:
            context$2$0.next = 37;
            break;

          case 28:
            if (!(protocol === W3C)) {
              context$2$0.next = 35;
              break;
            }

            if (!(response.statusCode < 300)) {
              context$2$0.next = 31;
              break;
            }

            return context$2$0.abrupt('return', resBody.value);

          case 31:
            if (!(_lodash2['default'].isPlainObject(resBody.value) && resBody.value.error)) {
              context$2$0.next = 33;
              break;
            }

            throw (0, _protocolErrors.errorFromW3CJsonCode)(resBody.value.error, resBody.value.message, resBody.value.stacktrace);

          case 33:
            context$2$0.next = 37;
            break;

          case 35:
            if (!(response.statusCode === 200)) {
              context$2$0.next = 37;
              break;
            }

            return context$2$0.abrupt('return', resBody);

          case 37:
            throw new _protocolErrors.errors.UnknownError('Did not know what to do with response code \'' + response.statusCode + '\' ' + ('and response body \'' + _lodash2['default'].truncate(JSON.stringify(resBody), { length: 300 }) + '\''));

          case 38:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[2, 11]]);
    }
  }, {
    key: 'getSessionIdFromUrl',
    value: function getSessionIdFromUrl(url) {
      var match = url.match(/\/session\/([^\/]+)/);
      return match ? match[1] : null;
    }
  }, {
    key: 'proxyReqRes',
    value: function proxyReqRes(req, res) {
      var _ref5, _ref52, response, body, reqSessionId;

      return _regeneratorRuntime.async(function proxyReqRes$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.proxyCommand(req.originalUrl, req.method, req.body));

          case 2:
            _ref5 = context$2$0.sent;
            _ref52 = _slicedToArray(_ref5, 2);
            response = _ref52[0];
            body = _ref52[1];

            res.headers = response.headers;
            res.set('content-type', response.headers['content-type']);
            // if the proxied response contains a sessionId that the downstream
            // driver has generated, we don't want to return that to the client.
            // Instead, return the id from the request or from current session
            body = _appiumSupport.util.safeJsonParse(body);
            if (body && body.sessionId) {
              reqSessionId = this.getSessionIdFromUrl(req.originalUrl);

              if (reqSessionId) {
                log.info('Replacing sessionId ' + body.sessionId + ' with ' + reqSessionId);
                body.sessionId = reqSessionId;
              } else if (this.sessionId) {
                log.info('Replacing sessionId ' + body.sessionId + ' with ' + this.sessionId);
                body.sessionId = this.sessionId;
              }
            }
            res.status(response.statusCode).send(JSON.stringify(body));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return JWProxy;
})();

exports['default'] = JWProxy;
module.exports = exports['default'];

// Some servers, like chromedriver may return response code 200 for non-zero JSONWP statuses

// If we got a non-MJSONWP response, return the result, nothing left to do

// If we got an error, return the error right away

// ...Otherwise, continue to the next timeouts call

// No matches found. Proceed normally

// Got response in MJSONWP format

// Got response in W3C format

// Unknown protocol. Keeping it because of the backward compatibility
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztzQkFBYyxRQUFROzs7OzZCQUNPLGdCQUFnQjs7OEJBQ3pCLGlCQUFpQjs7OztrQ0FDSix5QkFBeUI7OzhCQUM0QixvQkFBb0I7O2dDQUNuRixzQkFBc0I7Ozs7OEJBQ1Ysb0JBQW9COztBQUd2RCxJQUFNLEdBQUcsR0FBRyxzQkFBTyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUM7O0FBRTdDLElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQztBQUM1QixJQUFNLHVCQUF1QixHQUFHLE1BQU0sQ0FBQzs7QUFFdkMsSUFBTSxzQkFBc0IsR0FBRyxDQUM3QjtBQUNFLGNBQVksRUFBRSxDQUFDLFNBQVMsRUFBRSxjQUFjLENBQUM7QUFDekMsaUJBQWUsRUFBRSx5QkFBQyxHQUFHO1dBQUssR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQ2pELEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsZ0JBQWdCLEdBQUcsVUFBVSxDQUFDO0dBQUE7QUFDeEQsY0FBWSxFQUFFLHNCQUFDLEdBQUc7V0FBSyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFDOUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxnQkFBZ0IsR0FBRyxlQUFlLENBQUM7R0FBQTtDQUM5RCxFQUNEO0FBQ0UsY0FBWSxFQUFFLENBQUMsc0JBQXNCLENBQUM7QUFDdEMsaUJBQWUsRUFBRSx5QkFBQyxHQUFHO1dBQUssR0FBRyxDQUFDLE9BQU8sQ0FBQyxrQ0FBa0MsRUFDdEUsZ0JBQWdCLENBQUM7R0FBQTtBQUNuQixjQUFZLEVBQUUsc0JBQUMsR0FBRztXQUFLLEdBQUcsQ0FBQyxPQUFPLENBQUMsd0JBQXdCLEVBQ3pELHdCQUF3QixDQUFDO0dBQUE7Q0FDNUIsQ0FDRixDQUFDOztrQ0FFcUIsOEJBQVcsZUFBZTtJQUExQyxPQUFPLCtCQUFQ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QUFDLGNBQWMsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7Ozs7QUFJMUQsZ0JBQUksR0FBRyxvQkFBSyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDaEMsZ0JBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7QUFDcEIsMEJBQVksR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQzs7QUFDOUQsa0JBQUksWUFBWSxFQUFFO0FBQ2hCLG1CQUFHLENBQUMsSUFBSSwwQkFBd0IsSUFBSSxDQUFDLFNBQVMsY0FBUyxZQUFZLENBQUcsQ0FBQztBQUN2RSxvQkFBSSxDQUFDLFNBQVMsR0FBRyxZQUFZLENBQUM7ZUFDL0IsTUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7QUFDekIsbUJBQUcsQ0FBQyxJQUFJLDBCQUF3QixJQUFJLENBQUMsU0FBUyxjQUFTLElBQUksQ0FBQyxTQUFTLENBQUcsQ0FBQztBQUN6RSxvQkFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO2VBQ2pDO2FBQ0Y7QUFDRCxlQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDOzs7Ozs7O0tBQzVEOzs7U0FwWUcsT0FBTzs7O3FCQXVZRSxPQUFPIiwiZmlsZSI6ImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgbG9nZ2VyLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCB7IGdldFN1bW1hcnlCeUNvZGUgfSBmcm9tICcuLi9qc29ud3Atc3RhdHVzL3N0YXR1cyc7XG5pbXBvcnQgeyBlcnJvcnMsIGlzRXJyb3JUeXBlLCBlcnJvckZyb21NSlNPTldQU3RhdHVzQ29kZSwgZXJyb3JGcm9tVzNDSnNvbkNvZGUgfSBmcm9tICcuLi9wcm90b2NvbC9lcnJvcnMnO1xuaW1wb3J0IEJhc2VEcml2ZXIgZnJvbSAnLi4vYmFzZWRyaXZlci9kcml2ZXInO1xuaW1wb3J0IHsgcm91dGVUb0NvbW1hbmROYW1lIH0gZnJvbSAnLi4vcHJvdG9jb2wvcm91dGVzJztcblxuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdKU09OV1AgUHJveHknKTtcbi8vIFRPRE86IE1ha2UgdGhpcyB2YWx1ZSBjb25maWd1cmFibGUgYXMgYSBzZXJ2ZXIgc2lkZSBjYXBhYmlsaXR5XG5jb25zdCBMT0dfT0JKX0xFTkdUSCA9IDEwMjQ7IC8vIE1BWCBMRU5HVEggTG9nZ2VkIHRvIGZpbGUgLyBjb25zb2xlXG5jb25zdCBERUZBVUxUX1JFUVVFU1RfVElNRU9VVCA9IDI0MDAwMDtcblxuY29uc3QgQ09NTUFORF9VUkxTX0NPTkZMSUNUUyA9IFtcbiAge1xuICAgIGNvbW1hbmROYW1lczogWydleGVjdXRlJywgJ2V4ZWN1dGVBc3luYyddLFxuICAgIGpzb253cENvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL2V4ZWN1dGUuKi8sXG4gICAgICB1cmwuaW5jbHVkZXMoJ2FzeW5jJykgPyAnL2V4ZWN1dGVfYXN5bmMnIDogJy9leGVjdXRlJyksXG4gICAgdzNjQ29udmVydGVyOiAodXJsKSA9PiB1cmwucmVwbGFjZSgvXFwvZXhlY3V0ZS4qLyxcbiAgICAgIHVybC5pbmNsdWRlcygnYXN5bmMnKSA/ICcvZXhlY3V0ZS9hc3luYycgOiAnL2V4ZWN1dGUvc3luYycpLFxuICB9LFxuICB7XG4gICAgY29tbWFuZE5hbWVzOiBbJ2dldEVsZW1lbnRTY3JlZW5zaG90J10sXG4gICAganNvbndwQ29udmVydGVyOiAodXJsKSA9PiB1cmwucmVwbGFjZSgvXFwvZWxlbWVudFxcLyhbXlxcL10rKVxcL3NjcmVlbnNob3QkLyxcbiAgICAgICcvc2NyZWVuc2hvdC8kMScpLFxuICAgIHczY0NvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL3NjcmVlbnNob3RcXC8oW15cXC9dKykvLFxuICAgICAgJy9lbGVtZW50LyQxL3NjcmVlbnNob3QnKSxcbiAgfSxcbl07XG5cbmNvbnN0IHtNSlNPTldQLCBXM0N9ID0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0w7XG5cbmNsYXNzIEpXUHJveHkge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCB7XG4gICAgICBzY2hlbWU6ICdodHRwJyxcbiAgICAgIHNlcnZlcjogJ2xvY2FsaG9zdCcsXG4gICAgICBwb3J0OiA0NDQ0LFxuICAgICAgYmFzZTogJy93ZC9odWInLFxuICAgICAgc2Vzc2lvbklkOiBudWxsLFxuICAgICAgdGltZW91dDogREVGQVVMVF9SRVFVRVNUX1RJTUVPVVQsXG4gICAgfSwgb3B0cyk7XG4gICAgdGhpcy5zY2hlbWUgPSB0aGlzLnNjaGVtZS50b0xvd2VyQ2FzZSgpO1xuICAgIHRoaXMuX2FjdGl2ZVJlcXVlc3RzID0gW107XG4gIH1cblxuICAvLyBhYnN0cmFjdCB0aGUgY2FsbCBiZWhpbmQgYSBtZW1iZXIgZnVuY3Rpb25cbiAgLy8gc28gdGhhdCB3ZSBjYW4gbW9jayBpdCBpbiB0ZXN0c1xuICBhc3luYyByZXF1ZXN0ICguLi5hcmdzKSB7XG4gICAgY29uc3QgY3VycmVudFJlcXVlc3QgPSByZXF1ZXN0KC4uLmFyZ3MpO1xuICAgIHRoaXMuX2FjdGl2ZVJlcXVlc3RzLnB1c2goY3VycmVudFJlcXVlc3QpO1xuICAgIHJldHVybiBhd2FpdCBjdXJyZW50UmVxdWVzdC5maW5hbGx5KCgpID0+IF8ucHVsbCh0aGlzLl9hY3RpdmVSZXF1ZXN0cywgY3VycmVudFJlcXVlc3QpKTtcbiAgfVxuXG4gIGdldEFjdGl2ZVJlcXVlc3RzQ291bnQgKCkge1xuICAgIHJldHVybiB0aGlzLl9hY3RpdmVSZXF1ZXN0cy5sZW5ndGg7XG4gIH1cblxuICBjYW5jZWxBY3RpdmVSZXF1ZXN0cyAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGZvciAobGV0IHIgb2YgdGhpcy5fYWN0aXZlUmVxdWVzdHMpIHtcbiAgICAgICAgci5jYW5jZWwoKTtcbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5fYWN0aXZlUmVxdWVzdHMgPSBbXTtcbiAgICB9XG4gIH1cblxuICBlbmRwb2ludFJlcXVpcmVzU2Vzc2lvbklkIChlbmRwb2ludCkge1xuICAgIHJldHVybiAhXy5pbmNsdWRlcyhbJy9zZXNzaW9uJywgJy9zZXNzaW9ucycsICcvc3RhdHVzJ10sIGVuZHBvaW50KTtcbiAgfVxuXG4gIGdldFVybEZvclByb3h5ICh1cmwpIHtcbiAgICBpZiAodXJsID09PSAnJykge1xuICAgICAgdXJsID0gJy8nO1xuICAgIH1cbiAgICBjb25zdCBwcm94eUJhc2UgPSBgJHt0aGlzLnNjaGVtZX06Ly8ke3RoaXMuc2VydmVyfToke3RoaXMucG9ydH0ke3RoaXMuYmFzZX1gO1xuICAgIGNvbnN0IGVuZHBvaW50UmUgPSAnKC8oc2Vzc2lvbnxzdGF0dXMpKSc7XG4gICAgbGV0IHJlbWFpbmluZ1VybCA9ICcnO1xuICAgIGlmICgvXmh0dHAvLnRlc3QodXJsKSkge1xuICAgICAgY29uc3QgZmlyc3QgPSAobmV3IFJlZ0V4cChgKGh0dHBzPzovLy4rKSR7ZW5kcG9pbnRSZX1gKSkuZXhlYyh1cmwpO1xuICAgICAgaWYgKCFmaXJzdCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dvdCBhIGNvbXBsZXRlIHVybCBidXQgY291bGQgbm90IGV4dHJhY3QgSldQIGVuZHBvaW50Jyk7XG4gICAgICB9XG4gICAgICByZW1haW5pbmdVcmwgPSB1cmwucmVwbGFjZShmaXJzdFsxXSwgJycpO1xuICAgIH0gZWxzZSBpZiAoKG5ldyBSZWdFeHAoJ14vJykpLnRlc3QodXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gdXJsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYERpZCBub3Qga25vdyB3aGF0IHRvIGRvIHdpdGggdXJsICcke3VybH0nYCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RyaXBQcmVmaXhSZSA9IG5ldyBSZWdFeHAoJ14uKj8oLyhzZXNzaW9ufHN0YXR1cykuKikkJyk7XG4gICAgaWYgKHN0cmlwUHJlZml4UmUudGVzdChyZW1haW5pbmdVcmwpKSB7XG4gICAgICByZW1haW5pbmdVcmwgPSBzdHJpcFByZWZpeFJlLmV4ZWMocmVtYWluaW5nVXJsKVsxXTtcbiAgICB9XG5cbiAgICBpZiAoIShuZXcgUmVnRXhwKGVuZHBvaW50UmUpKS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IGAvc2Vzc2lvbi8ke3RoaXMuc2Vzc2lvbklkfSR7cmVtYWluaW5nVXJsfWA7XG4gICAgfVxuXG4gICAgY29uc3QgcmVxdWlyZXNTZXNzaW9uSWQgPSB0aGlzLmVuZHBvaW50UmVxdWlyZXNTZXNzaW9uSWQocmVtYWluaW5nVXJsKTtcblxuICAgIGlmIChyZXF1aXJlc1Nlc3Npb25JZCAmJiB0aGlzLnNlc3Npb25JZCA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gcHJveHkgYSBzZXNzaW9uIGNvbW1hbmQgd2l0aG91dCBzZXNzaW9uIGlkJyk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2Vzc2lvbkJhc2VSZSA9IG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi8oW14vXSspJyk7XG4gICAgaWYgKHNlc3Npb25CYXNlUmUudGVzdChyZW1haW5pbmdVcmwpKSB7XG4gICAgICAvLyB3ZSBoYXZlIHNvbWV0aGluZyBsaWtlIC9zZXNzaW9uLzppZC9mb29iYXIsIHNvIHdlIG5lZWQgdG8gcmVwbGFjZVxuICAgICAgLy8gdGhlIHNlc3Npb24gaWRcbiAgICAgIGNvbnN0IG1hdGNoID0gc2Vzc2lvbkJhc2VSZS5leGVjKHJlbWFpbmluZ1VybCk7XG4gICAgICByZW1haW5pbmdVcmwgPSByZW1haW5pbmdVcmwucmVwbGFjZShtYXRjaFsxXSwgdGhpcy5zZXNzaW9uSWQpO1xuICAgIH0gZWxzZSBpZiAocmVxdWlyZXNTZXNzaW9uSWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgOnNlc3Npb24gc2VjdGlvbiBmb3IgdXJsOiAke3JlbWFpbmluZ1VybH1gKTtcbiAgICB9XG4gICAgcmVtYWluaW5nVXJsID0gcmVtYWluaW5nVXJsLnJlcGxhY2UoL1xcLyQvLCAnJyk7IC8vIGNhbid0IGhhdmUgdHJhaWxpbmcgc2xhc2hlc1xuXG4gICAgcmV0dXJuIHByb3h5QmFzZSArIHJlbWFpbmluZ1VybDtcbiAgfVxuXG4gIGFzeW5jIHByb3h5ICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBtZXRob2QgPSBtZXRob2QudG9VcHBlckNhc2UoKTtcbiAgICBjb25zdCBuZXdVcmwgPSB0aGlzLmdldFVybEZvclByb3h5KHVybCk7XG4gICAgY29uc3QgcmVxT3B0cyA9IHtcbiAgICAgIHVybDogbmV3VXJsLFxuICAgICAgbWV0aG9kLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnLFxuICAgICAgICAndXNlci1hZ2VudCc6ICdhcHBpdW0nLFxuICAgICAgICBhY2NlcHQ6ICcqLyonLFxuICAgICAgfSxcbiAgICAgIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlLFxuICAgICAgdGltZW91dDogdGhpcy50aW1lb3V0LFxuICAgICAgZm9yZXZlcjogdHJ1ZSxcbiAgICB9O1xuICAgIGlmIChib2R5ICE9PSBudWxsKSB7XG4gICAgICBpZiAodHlwZW9mIGJvZHkgIT09ICdvYmplY3QnKSB7XG4gICAgICAgIGJvZHkgPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgICAgfVxuICAgICAgcmVxT3B0cy5qc29uID0gYm9keTtcbiAgICB9XG5cbiAgICAvLyBHRVQgbWV0aG9kcyBzaG91bGRuJ3QgaGF2ZSBhbnkgYm9keS4gTW9zdCBzZXJ2ZXJzIGFyZSBPSyB3aXRoIHRoaXMsIGJ1dCBXZWJEcml2ZXJBZ2VudCB0aHJvd3MgNDAwIGVycm9yc1xuICAgIGlmIChtZXRob2QgPT09ICdHRVQnKSB7XG4gICAgICByZXFPcHRzLmpzb24gPSBudWxsO1xuICAgIH1cblxuICAgIGxvZy5kZWJ1ZyhgUHJveHlpbmcgWyR7bWV0aG9kfSAke3VybCB8fCBcIi9cIn1dIHRvIFske21ldGhvZH0gJHtuZXdVcmx9XSBgICtcbiAgICAgICAgICAgICAoYm9keSA/IGB3aXRoIGJvZHk6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShib2R5KSwge2xlbmd0aDogTE9HX09CSl9MRU5HVEh9KX1gIDogJ3dpdGggbm8gYm9keScpKTtcblxuICAgIGxldCByZXMsIHJlc0JvZHk7XG4gICAgdHJ5IHtcbiAgICAgIHJlcyA9IGF3YWl0IHRoaXMucmVxdWVzdChyZXFPcHRzKTtcbiAgICAgIHJlc0JvZHkgPSByZXMuYm9keTtcbiAgICAgIGxvZy5kZWJ1ZyhgR290IHJlc3BvbnNlIHdpdGggc3RhdHVzICR7cmVzLnN0YXR1c0NvZGV9OiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkocmVzQm9keSksIHtsZW5ndGg6IExPR19PQkpfTEVOR1RIfSl9YCk7XG4gICAgICBpZiAoL1xcL3Nlc3Npb24kLy50ZXN0KHVybCkgJiYgbWV0aG9kID09PSAnUE9TVCcpIHtcbiAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgICAgICB0aGlzLnNlc3Npb25JZCA9IHJlc0JvZHkuc2Vzc2lvbklkO1xuICAgICAgICB9IGVsc2UgaWYgKHJlcy5zdGF0dXNDb2RlID09PSAzMDMpIHtcbiAgICAgICAgICB0aGlzLnNlc3Npb25JZCA9IC9cXC9zZXNzaW9uXFwvKFteXFwvXSspLy5leGVjKHJlc0JvZHkpWzFdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCByZXNCb2R5T2JqID0gdXRpbC5zYWZlSnNvblBhcnNlKHJlc0JvZHkpO1xuICAgICAgaWYgKCF0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2wpIHtcbiAgICAgICAgdGhpcy5fZG93bnN0cmVhbVByb3RvY29sID0gdGhpcy5nZXRQcm90b2NvbEZyb21SZXNCb2R5KHJlc0JvZHlPYmopO1xuICAgICAgfVxuICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlIDwgNDAwICYmIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9PT0gTUpTT05XUCAmJiBwYXJzZUludChyZXNCb2R5T2JqLnN0YXR1cywgMTApICE9PSAwKSB7XG4gICAgICAgIC8vIFNvbWUgc2VydmVycywgbGlrZSBjaHJvbWVkcml2ZXIgbWF5IHJldHVybiByZXNwb25zZSBjb2RlIDIwMCBmb3Igbm9uLXplcm8gSlNPTldQIHN0YXR1c2VzXG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgVGhlIHJlcXVlc3QgdG8gJHt1cmx9IGhhcyBmYWlsZWRgO1xuICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgICAgIGVyci5tZXNzYWdlID0gbWVzc2FnZTtcbiAgICAgICAgZXJyLmVycm9yID0gcmVzQm9keTtcbiAgICAgICAgZXJyLnN0YXR1c0NvZGUgPSA1MDA7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsZXQgcmVzcG9uc2VFcnJvcjtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJlc3BvbnNlRXJyb3IgPSBKU09OLnBhcnNlKGUuZXJyb3IpO1xuICAgICAgfSBjYXRjaCAoZTEpIHtcbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoZS5lcnJvcikgJiYgXy5pc1N0cmluZyhlLmVycm9yKSkge1xuICAgICAgICAgIGxvZy53YXJuKGBHb3QgYW4gdW5leHBlY3RlZCByZXNwb25zZTogJHtfLnRydW5jYXRlKGUuZXJyb3IsIHtsZW5ndGg6IDMwMH0pfWApO1xuICAgICAgICB9XG4gICAgICAgIHJlc3BvbnNlRXJyb3IgPSBfLmlzUGxhaW5PYmplY3QoZS5lcnJvcikgPyBlLmVycm9yIDogbnVsbDtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IoYENvdWxkIG5vdCBwcm94eSBjb21tYW5kIHRvIHJlbW90ZSBzZXJ2ZXIuIGAgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWAsIHJlc3BvbnNlRXJyb3IsIGUuc3RhdHVzQ29kZSk7XG4gICAgfVxuICAgIHJldHVybiBbcmVzLCByZXNCb2R5XTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXM0MgL3RpbWVvdXRzIGNhbiB0YWtlIGFzIG1hbnkgYXMgMyB0aW1lb3V0IHR5cGVzIGF0IG9uY2UsIE1KU09OV1AgL3RpbWVvdXRzIG9ubHkgdGFrZXMgb25lXG4gICAqIGF0IGEgdGltZS4gU28gaWYgd2UncmUgdXNpbmcgVzNDIGFuZCBwcm94eWluZyB0byBNSlNPTldQIGFuZCB0aGVyZSdzIG1vcmUgdGhhbiBvbmUgdGltZW91dCB0eXBlXG4gICAqIHByb3ZpZGVkIGluIHRoZSByZXF1ZXN0LCB3ZSBuZWVkIHRvIGRvIDMgcHJveGllcyBhbmQgY29tYmluZSB0aGUgcmVzdWx0XG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBib2R5IFJlcXVlc3QgYm9keVxuICAgKiBAcmV0dXJuIHtBcnJheX0gQXJyYXkgb2YgVzNDICsgTUpTT05XUCBjb21wYXRpYmxlIHRpbWVvdXQgb2JqZWN0c1xuICAgKi9cbiAgYXN5bmMgZ2V0VGltZW91dFJlcXVlc3RPYmplY3RzIChib2R5KSB7XG4gICAgbGV0IGRvd25zdHJlYW1Qcm90b2NvbDtcbiAgICB0cnkge1xuICAgICAgZG93bnN0cmVhbVByb3RvY29sID0gYXdhaXQgdGhpcy5nZXREb3duc3RyZWFtUHJvdG9jb2woKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGVycik7XG4gICAgfVxuICAgIGlmICghZG93bnN0cmVhbVByb3RvY29sKSB7XG4gICAgICBsb2cud2FybignVGhlIGRvd25zdHJlYW0gcHJvdG9jb2wgY2Fubm90IGJlIGRldGVjdGVkLiBQcm94eWluZyB0aGUgcmVxdWVzdCBib2R5IHRvIC90aW1lb3V0cyBhcyBpcycpO1xuICAgICAgcmV0dXJuIFtib2R5XTtcbiAgICB9XG5cbiAgICBpZiAoZG93bnN0cmVhbVByb3RvY29sID09PSBXM0MgJiYgXy5oYXMoYm9keSwgJ21zJykgJiYgXy5oYXMoYm9keSwgJ3R5cGUnKSkge1xuICAgICAgY29uc3QgdHlwZVRvVzNDID0gKHgpID0+IHggPT09ICdwYWdlIGxvYWQnID8gJ3BhZ2VMb2FkJyA6IHg7XG4gICAgICByZXR1cm4gW3tcbiAgICAgICAgW3R5cGVUb1czQyhib2R5LnR5cGUpXTogYm9keS5tcyxcbiAgICAgIH1dO1xuICAgIH1cblxuICAgIGlmIChkb3duc3RyZWFtUHJvdG9jb2wgPT09IE1KU09OV1AgJiYgKCFfLmhhcyhib2R5LCAnbXMnKSB8fCAhXy5oYXMoYm9keSwgJ3R5cGUnKSkpIHtcbiAgICAgIGNvbnN0IHR5cGVUb0pTT05XUCA9ICh4KSA9PiB4ID09PSAncGFnZUxvYWQnID8gJ3BhZ2UgbG9hZCcgOiB4O1xuICAgICAgcmV0dXJuIF8udG9QYWlycyhib2R5KVxuICAgICAgICAuZmlsdGVyKChwYWlyKSA9PiAhaXNOYU4ocGFyc2VGbG9hdChwYWlyWzFdKSkpXG4gICAgICAgIC5tYXAoKHBhaXIpID0+IHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHlwZTogdHlwZVRvSlNPTldQKHBhaXJbMF0pLFxuICAgICAgICAgICAgbXM6IHBhaXJbMV0sXG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFtib2R5XTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcm94eSBhbiBhcnJheSBvZiB0aW1lb3V0IG9iamVjdHMgYW5kIG1lcmdlIHRoZSByZXN1bHRcbiAgICogQHBhcmFtIHtTdHJpbmd9IHVybCBFbmRwb2ludCB1cmxcbiAgICogQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCBFbmRwb2ludCBtZXRob2RcbiAgICogQHBhcmFtIHtPYmplY3R9IGJvZHkgUmVxdWVzdCBib2R5XG4gICAqL1xuICBhc3luYyBwcm94eVNldFRpbWVvdXRzICh1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIGxldCByZXNwb25zZSwgcmVzQm9keTtcblxuICAgIGNvbnN0IHRpbWVvdXRSZXF1ZXN0T2JqZWN0cyA9IGF3YWl0IHRoaXMuZ2V0VGltZW91dFJlcXVlc3RPYmplY3RzKGJvZHkpO1xuICAgIGxvZy5kZWJ1ZyhgV2lsbCBzZW5kIHRoZSBmb2xsb3dpbmcgcmVxdWVzdCBib2RpZXMgdG8gL3RpbWVvdXRzOiAke0pTT04uc3RyaW5naWZ5KHRpbWVvdXRSZXF1ZXN0T2JqZWN0cyl9YCk7XG4gICAgZm9yIChjb25zdCB0aW1lb3V0T2JqIG9mIHRpbWVvdXRSZXF1ZXN0T2JqZWN0cykge1xuICAgICAgW3Jlc3BvbnNlLCByZXNCb2R5XSA9IGF3YWl0IHRoaXMucHJveHkodXJsLCBtZXRob2QsIHRpbWVvdXRPYmopO1xuXG4gICAgICBjb25zdCBwcm90b2NvbCA9IHRoaXMuZ2V0UHJvdG9jb2xGcm9tUmVzQm9keShyZXNCb2R5KTtcblxuICAgICAgLy8gSWYgd2UgZ290IGEgbm9uLU1KU09OV1AgcmVzcG9uc2UsIHJldHVybiB0aGUgcmVzdWx0LCBub3RoaW5nIGxlZnQgdG8gZG9cbiAgICAgIGlmIChwcm90b2NvbCAhPT0gTUpTT05XUCkge1xuICAgICAgICByZXR1cm4gW3Jlc3BvbnNlLCByZXNCb2R5XTtcbiAgICAgIH1cblxuICAgICAgLy8gSWYgd2UgZ290IGFuIGVycm9yLCByZXR1cm4gdGhlIGVycm9yIHJpZ2h0IGF3YXlcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID49IDQwMCkge1xuICAgICAgICByZXR1cm4gW3Jlc3BvbnNlLCByZXNCb2R5XTtcbiAgICAgIH1cblxuICAgICAgLy8gLi4uT3RoZXJ3aXNlLCBjb250aW51ZSB0byB0aGUgbmV4dCB0aW1lb3V0cyBjYWxsXG4gICAgfVxuICAgIHJldHVybiBbcmVzcG9uc2UsIHJlc0JvZHldO1xuICB9XG5cbiAgZ2V0UHJvdG9jb2xGcm9tUmVzQm9keSAocmVzQm9keSkge1xuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHJlc0JvZHkpKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXNCb2R5ID0gSlNPTi5wYXJzZShyZXNCb2R5KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKHJlc0JvZHkuc3RhdHVzKSkge1xuICAgICAgcmV0dXJuIE1KU09OV1A7XG4gICAgfVxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKHJlc0JvZHkudmFsdWUpKSB7XG4gICAgICByZXR1cm4gVzNDO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldERvd25zdHJlYW1Qcm90b2NvbCAoKSB7XG4gICAgaWYgKCF0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2wpIHtcbiAgICAgIGNvbnN0IFssIHJlc0JvZHldID0gYXdhaXQgdGhpcy5wcm94eSgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IHRoaXMuZ2V0UHJvdG9jb2xGcm9tUmVzQm9keShyZXNCb2R5KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbDtcbiAgfVxuXG4gIHJlcXVlc3RUb0NvbW1hbmROYW1lICh1cmwsIG1ldGhvZCkge1xuICAgIGNvbnN0IGV4dHJhY3RDb21tYW5kTmFtZSA9IChwYXR0ZXJuKSA9PiB7XG4gICAgICBjb25zdCBwYXRoTWF0Y2ggPSBwYXR0ZXJuLmV4ZWModXJsKTtcbiAgICAgIHJldHVybiBwYXRoTWF0Y2ggPyByb3V0ZVRvQ29tbWFuZE5hbWUocGF0aE1hdGNoWzFdLCBtZXRob2QpIDogbnVsbDtcbiAgICB9O1xuICAgIGxldCBjb21tYW5kTmFtZSA9IHJvdXRlVG9Db21tYW5kTmFtZSh1cmwsIG1ldGhvZCk7XG4gICAgaWYgKCFjb21tYW5kTmFtZSAmJiBfLmluY2x1ZGVzKHVybCwgJy93ZC9odWIvc2Vzc2lvbi8nKSkge1xuICAgICAgY29tbWFuZE5hbWUgPSBleHRyYWN0Q29tbWFuZE5hbWUoL1xcL3dkXFwvaHViXFwvc2Vzc2lvblxcL1teXFwvXSsoLispLyk7XG4gICAgfVxuICAgIGlmICghY29tbWFuZE5hbWUgJiYgXy5pbmNsdWRlcyh1cmwsICcvd2QvaHViLycpKSB7XG4gICAgICBjb21tYW5kTmFtZSA9IGV4dHJhY3RDb21tYW5kTmFtZSgvXFwvd2RcXC9odWIoXFwvLispLyk7XG4gICAgfVxuICAgIHJldHVybiBjb21tYW5kTmFtZTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5Q29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgY29uc3QgY29tbWFuZE5hbWUgPSB0aGlzLnJlcXVlc3RUb0NvbW1hbmROYW1lKHVybCwgbWV0aG9kKTtcbiAgICBpZiAoIWNvbW1hbmROYW1lKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eSh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgTWF0Y2hlZCAnJHt1cmx9JyB0byBjb21tYW5kIG5hbWUgJyR7Y29tbWFuZE5hbWV9J2ApO1xuXG4gICAgLy8gSGFuZGxlIFwiY3Jvc3NpbmdcIiBlbmRwb2ludHMgZm9yIHRoZSBjYXNlXG4gICAgLy8gd2hlbiB1cHN0cmVhbSBhbmQgZG93bnN0cmVhbSBkcml2ZXJzIG9wZXJhdGUgZGlmZmVyZW50IHByb3RvY29sc1xuXG4gICAgLy8gU2FtZSB1cmwsIGJ1dCBkaWZmZXJlbnQgYXJndW1lbnRzXG5cbiAgICBpZiAoY29tbWFuZE5hbWUgPT09ICd0aW1lb3V0cycpICB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eVNldFRpbWVvdXRzKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgICB9XG5cbiAgICAvLyBTYW1lIGFyZ3VtZW50cywgYnV0IGRpZmZlcmVudCBVUkxzXG5cbiAgICBmb3IgKGNvbnN0IHtjb21tYW5kTmFtZXMsIGpzb253cENvbnZlcnRlciwgdzNjQ29udmVydGVyfSBvZiBDT01NQU5EX1VSTFNfQ09ORkxJQ1RTKSB7XG4gICAgICBpZiAoIWNvbW1hbmROYW1lcy5pbmNsdWRlcyhjb21tYW5kTmFtZSkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGxldCBkb3duc3RyZWFtUHJvdG9jb2w7XG4gICAgICB0cnkge1xuICAgICAgICBkb3duc3RyZWFtUHJvdG9jb2wgPSBhd2FpdCB0aGlzLmdldERvd25zdHJlYW1Qcm90b2NvbCgpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZy53YXJuKGVycik7XG4gICAgICB9XG4gICAgICBpZiAoIWRvd25zdHJlYW1Qcm90b2NvbCkge1xuICAgICAgICBsb2cud2FybignVGhlIGRvd25zdHJlYW0gcHJvdG9jb2wgY2Fubm90IGJlIGRldGVjdGVkLiBQcm94eWluZyBhcyBpcycpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJld3JpdHRlblVybCA9IGRvd25zdHJlYW1Qcm90b2NvbCA9PT0gTUpTT05XUFxuICAgICAgICA/IGpzb253cENvbnZlcnRlcih1cmwpXG4gICAgICAgIDogdzNjQ29udmVydGVyKHVybCk7XG4gICAgICBpZiAocmV3cml0dGVuVXJsID09PSB1cmwpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBEaWQgbm90IGtub3cgaG93IHRvIHJld3JpdGUgdGhlIG9yaWdpbmFsIFVSTCAnJHt1cmx9JyBgICtcbiAgICAgICAgICBgZm9yICR7ZG93bnN0cmVhbVByb3RvY29sfSBwcm90b2NvbGApO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGxvZy5pbmZvKGBSZXdyb3RlIHRoZSBvcmlnaW5hbCBVUkwgJyR7dXJsfScgdG8gJyR7cmV3cml0dGVuVXJsfScgYCArXG4gICAgICAgIGBmb3IgJHtkb3duc3RyZWFtUHJvdG9jb2x9IHByb3RvY29sYCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eShyZXdyaXR0ZW5VcmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfVxuXG4gICAgLy8gTm8gbWF0Y2hlcyBmb3VuZC4gUHJvY2VlZCBub3JtYWxseVxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5KHVybCwgbWV0aG9kLCBib2R5KTtcbiAgfVxuXG4gIGFzeW5jIGNvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIGxldCByZXNwb25zZTtcbiAgICBsZXQgcmVzQm9keTtcbiAgICB0cnkge1xuICAgICAgW3Jlc3BvbnNlLCByZXNCb2R5XSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChpc0Vycm9yVHlwZShlcnIsIGVycm9ycy5Qcm94eVJlcXVlc3RFcnJvcikpIHtcbiAgICAgICAgdGhyb3cgZXJyLmdldEFjdHVhbEVycm9yKCk7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihlcnIubWVzc2FnZSk7XG4gICAgfVxuICAgIHJlc0JvZHkgPSB1dGlsLnNhZmVKc29uUGFyc2UocmVzQm9keSk7XG4gICAgbGV0IHByb3RvY29sID0gdGhpcy5nZXRQcm90b2NvbEZyb21SZXNCb2R5KHJlc0JvZHkpO1xuICAgIGlmIChwcm90b2NvbCA9PT0gTUpTT05XUCkge1xuICAgICAgLy8gR290IHJlc3BvbnNlIGluIE1KU09OV1AgZm9ybWF0XG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwICYmIHJlc0JvZHkuc3RhdHVzID09PSAwKSB7XG4gICAgICAgIHJldHVybiByZXNCb2R5LnZhbHVlO1xuICAgICAgfVxuICAgICAgY29uc3Qgc3RhdHVzID0gcGFyc2VJbnQocmVzQm9keS5zdGF0dXMsIDEwKTtcbiAgICAgIGlmICghaXNOYU4oc3RhdHVzKSAmJiBzdGF0dXMgIT09IDApIHtcbiAgICAgICAgbGV0IG1lc3NhZ2UgPSByZXNCb2R5LnZhbHVlO1xuICAgICAgICBpZiAoXy5oYXMocmVzQm9keS52YWx1ZSwgJ21lc3NhZ2UnKSkge1xuICAgICAgICAgIG1lc3NhZ2UgPSBfLmlzRW1wdHkobWVzc2FnZSkgPyByZXNCb2R5LnZhbHVlLm1lc3NhZ2UgOiBgJHttZXNzYWdlfSAke3Jlc0JvZHkudmFsdWUubWVzc2FnZX1gO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlKHN0YXR1cywgXy5pc0VtcHR5KG1lc3NhZ2UpID8gZ2V0U3VtbWFyeUJ5Q29kZShzdGF0dXMpIDogbWVzc2FnZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChwcm90b2NvbCA9PT0gVzNDKSB7XG4gICAgICAvLyBHb3QgcmVzcG9uc2UgaW4gVzNDIGZvcm1hdFxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDApIHtcbiAgICAgICAgcmV0dXJuIHJlc0JvZHkudmFsdWU7XG4gICAgICB9XG4gICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHJlc0JvZHkudmFsdWUpICYmIHJlc0JvZHkudmFsdWUuZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3JGcm9tVzNDSnNvbkNvZGUocmVzQm9keS52YWx1ZS5lcnJvciwgcmVzQm9keS52YWx1ZS5tZXNzYWdlLCByZXNCb2R5LnZhbHVlLnN0YWNrdHJhY2UpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAvLyBVbmtub3duIHByb3RvY29sLiBLZWVwaW5nIGl0IGJlY2F1c2Ugb2YgdGhlIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICAgIHJldHVybiByZXNCb2R5O1xuICAgIH1cbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCByZXNwb25zZSBjb2RlICcke3Jlc3BvbnNlLnN0YXR1c0NvZGV9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgYW5kIHJlc3BvbnNlIGJvZHkgJyR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShyZXNCb2R5KSwge2xlbmd0aDogMzAwfSl9J2ApO1xuICB9XG5cbiAgZ2V0U2Vzc2lvbklkRnJvbVVybCAodXJsKSB7XG4gICAgY29uc3QgbWF0Y2ggPSB1cmwubWF0Y2goL1xcL3Nlc3Npb25cXC8oW15cXC9dKykvKTtcbiAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IG51bGw7XG4gIH1cblxuICBhc3luYyBwcm94eVJlcVJlcyAocmVxLCByZXMpIHtcbiAgICBsZXQgW3Jlc3BvbnNlLCBib2R5XSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKHJlcS5vcmlnaW5hbFVybCwgcmVxLm1ldGhvZCwgcmVxLmJvZHkpO1xuXG4gICAgcmVzLmhlYWRlcnMgPSByZXNwb25zZS5oZWFkZXJzO1xuICAgIHJlcy5zZXQoJ2NvbnRlbnQtdHlwZScsIHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKTtcbiAgICAvLyBpZiB0aGUgcHJveGllZCByZXNwb25zZSBjb250YWlucyBhIHNlc3Npb25JZCB0aGF0IHRoZSBkb3duc3RyZWFtXG4gICAgLy8gZHJpdmVyIGhhcyBnZW5lcmF0ZWQsIHdlIGRvbid0IHdhbnQgdG8gcmV0dXJuIHRoYXQgdG8gdGhlIGNsaWVudC5cbiAgICAvLyBJbnN0ZWFkLCByZXR1cm4gdGhlIGlkIGZyb20gdGhlIHJlcXVlc3Qgb3IgZnJvbSBjdXJyZW50IHNlc3Npb25cbiAgICBib2R5ID0gdXRpbC5zYWZlSnNvblBhcnNlKGJvZHkpO1xuICAgIGlmIChib2R5ICYmIGJvZHkuc2Vzc2lvbklkKSB7XG4gICAgICBjb25zdCByZXFTZXNzaW9uSWQgPSB0aGlzLmdldFNlc3Npb25JZEZyb21VcmwocmVxLm9yaWdpbmFsVXJsKTtcbiAgICAgIGlmIChyZXFTZXNzaW9uSWQpIHtcbiAgICAgICAgbG9nLmluZm8oYFJlcGxhY2luZyBzZXNzaW9uSWQgJHtib2R5LnNlc3Npb25JZH0gd2l0aCAke3JlcVNlc3Npb25JZH1gKTtcbiAgICAgICAgYm9keS5zZXNzaW9uSWQgPSByZXFTZXNzaW9uSWQ7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuc2Vzc2lvbklkKSB7XG4gICAgICAgIGxvZy5pbmZvKGBSZXBsYWNpbmcgc2Vzc2lvbklkICR7Ym9keS5zZXNzaW9uSWR9IHdpdGggJHt0aGlzLnNlc3Npb25JZH1gKTtcbiAgICAgICAgYm9keS5zZXNzaW9uSWQgPSB0aGlzLnNlc3Npb25JZDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmVzLnN0YXR1cyhyZXNwb25zZS5zdGF0dXNDb2RlKS5zZW5kKEpTT04uc3RyaW5naWZ5KGJvZHkpKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBKV1Byb3h5O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
